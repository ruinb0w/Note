# 传输层

传输层提供了端到端的服务, 即可以让同一主机或不同主机上的进程进行通信.还提供了多路复用和多路分用机制, 使得多个进程同时通信成为可能.

传输层依赖于网络层提供的服务, 并适当的增强网络层的服务.

传输层的协议有UDP和TCP两种

## TCP

特点

* 面向连接: 点对点的全双功连接
* 提供: 流量控制, 拥塞控制, 差错控制, 流水线机制
* 不提供: 时间/延迟保障, 最小带宽保障

![1556189226586](assets/1556189226586.png)

### 序列号和ACK

TCP的序列号是随机的, 取的是segment中的第一个字节

ACK字段的内容是希望接收的下一个字节的序列号. 例如上一个segment编号90, 大小8bit那么接收端回复的ACK段内容为98.

### 可靠数据传输

流水线机制, 累积确认, 单一重传定时器

#### 超时间隔

评估RTT:

$EstimatedRTT = (1- \alpha)\times EstimatedRTT + \alpha\times SampleRTT$

> typically, $\alpha = 0.125$

评估安全边界:

$DevRTT = (1- \beta)\times DevRTT +\beta \times|SampleRTT-EstimatedRTT|$

> typically, $\beta = 0.25$

超时延迟:

$TimeoutInterval = EstimatedRTT + 4\times DevRTT$

### 超时操作

重传引起超时的Segment, 重启定时器

## UDP

User Datagram Protocol, 用户数据段协议, 是一种无连接,不可靠的数据传输

功能

* 提供: 简单的差错控制

* 不提供: 可靠性保障, 流量控制, 拥塞控制, 延迟保障, 带宽保障

优点

* 无需建立连接 (减少延迟)
* 实现简单:无需维护连接状态
* 头部开销少
* 没有拥塞控制: 应用可更好地控制发送时间和速率

![1556097683864](assets/1556097683864.png)

### 差错检测

目的: UDP校验和的目的是检测UDP段在传输中是否发生错误(如位翻转)

工作原理

* 发送方: 将段内容视作多组16位整数, 将多组整数相加, 进位加载最右端, 将和按位取反即得到校验和
* 接收方: 接收到的校验和和内容不匹配则说明出错, 但匹配也不一定就正确

## 可靠数据传输原理

可靠数据传输应当满足**不错**、**不丢**、**不乱**. 通信信道通常是不可靠的, 很多因素都会导致传输出错, 所以需要在收发双发来单独实现一套可靠的数据传输协议. 

可靠数据传输的实现办法

- 不错: 采用校验和机制
- 不丢: 采用时延机制
- 不乱: 采用序列号机制

## 滑动窗口协议

为了实现可靠数据传输就必然会引发停等现象, 即发送方需要等接收方的确认后再进一步操作, 为了解决这个问题就需要引入流水线机制, 其中应用广泛的就是滑动窗口协议.

#### GBN协议

![1556100047040](assets/1556100047040.png)

#### SR协议

![1556100114746](assets/1556100114746.png)

## 多路复用和多路分用

### 多路分用

实现: 每个接收到的数据报(由网络层封装)都携带源IP地址和目的IP地址,并携带一个由传输层封装的数据段, 数据段封装了源端口号和目的端口号. 传输层拿到数据段后提交给相应的socket即可.

无连接分用: 主机检测到数据段是UDP段就将该段内容提交给相应的socket

有连接分用: 主机检测到数据段是TCP段会先确认IP和端口再提交给socket



### 



### 

